<head>
    <meta charset="utf-8">
    <title>media stream webcam test</title>
</head>
<body>

</body>

<style>
    body {
        width: 100%;
        height: 100%;
    }

    .fixed {
        position: fixed;
    }

    #video {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 100%;
    }

    textarea {
        resize: none;
        width: 300px;
        height: 400px;
    }

</style>

<script>
    if (!navigator.mediaDevices.getUserMedia) {
        alert("not supported on this browser");
    }

    (async () => {
        const FACING_MODE_ENVIRONMENT = 'environment';
        const FACING_MODE_USER = 'user';
        let mode = FACING_MODE_ENVIRONMENT;
        let currentDeviceId = 'default';

        document.querySelector('.switch').addEventListener('click', () => {
            mode = mode === FACING_MODE_USER ? FACING_MODE_ENVIRONMENT : FACING_MODE_USER;
            reStartStreamingVideo();
        });

        document.querySelector('.restart').addEventListener('click', () => {
            reStartStreamingVideo();
        });

        const reStartStreamingVideo = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: mode,
                    deviceId: currentDeviceId,
                },
            })
            document.querySelector('#video').srcObject = stream;

            const texts = [];
            stream.getTracks().forEach(t => {
                const s = t.getSettings();
                texts.push(`setting.aspectRatio: ${s.aspectRatio}`);
                texts.push(`setting.autoGainControl: ${s.autoGainControl}`);
                texts.push(`setting.channelCount: ${s.channelCount}`);
                texts.push(`setting.deviceId: ${s.deviceId}`);
                texts.push(`setting.echoCancellation: ${s.echoCancellation}`);
                texts.push(`setting.facingMode: ${s.facingMode}`);
                texts.push(`setting.frameRate: ${s.frameRate}`);
                texts.push(`setting.groupId: ${s.groupId}`);
                texts.push(`setting.height: ${s.height}`);
                texts.push(`setting.latency: ${s.latency}`);
                texts.push(`setting.noiseSuppression: ${s.noiseSuppression}`);
                texts.push(`setting.sampleRate: ${s.sampleRate}`);
                texts.push(`setting.sampleSize: ${s.sampleSize}`);
                texts.push(`setting.width: ${s.width}`);
                texts.push("")

                const c = t.getCapabilities();
                texts.push(`capabilities.aspectRatio: ${c.aspectRatio}`);
                texts.push(`capabilities.autoGainControl: ${c.autoGainControl}`);
                texts.push(`capabilities.channelCount: ${c.channelCount}`);
                texts.push(`capabilities.deviceId: ${c.deviceId}`);
                texts.push(`capabilities.echoCancellation: ${c.echoCancellation}`);
                texts.push(`capabilities.facingMode: ${c.facingMode}`);
                texts.push(`capabilities.frameRate: ${c.frameRate}`);
                texts.push(`capabilities.groupId: ${c.groupId}`);
                texts.push(`capabilities.height: ${c.height}`);
                texts.push(`capabilities.latency: ${c.latency}`);
                texts.push(`capabilities.noiseSuppression: ${c.noiseSuppression}`);
                texts.push(`capabilities.sampleRate: ${c.sampleRate}`);
                texts.push(`capabilities.sampleSize: ${c.sampleSize}`);
                texts.push(`capabilities.width: ${c.width}`);
                texts.push("")

                const cc = t.getConstraints();
                texts.push(`constraints.aspectRatio: ${cc.advanced}`);
                texts.push(`constraints.aspectRatio: ${cc.aspectRatio}`);
                texts.push(`constraints.autoGainControl: ${cc.autoGainControl}`);
                texts.push(`constraints.channelCount: ${cc.channelCount}`);
                texts.push(`constraints.deviceId: ${cc.deviceId}`);
                texts.push(`constraints.echoCancellation: ${cc.echoCancellation}`);
                texts.push(`constraints.facingMode: ${cc.facingMode}`);
                texts.push(`constraints.frameRate: ${cc.frameRate}`);
                texts.push(`constraints.groupId: ${cc.groupId}`);
                texts.push(`constraints.height: ${cc.height}`);
                texts.push(`constraints.latency: ${cc.latency}`);
                texts.push(`constraints.noiseSuppression: ${cc.noiseSuppression}`);
                texts.push(`constraints.sampleRate: ${cc.sampleRate}`);
                texts.push(`constraints.sampleSize: ${cc.sampleSize}`);
                texts.push(`constraints.width: ${cc.width}`);
            });
            document.querySelector(".infos").value = texts.join("\n");
        };
        // reStartStreamingVideo();

        const refreshDeviceList = async () => {
            document.querySelectorAll('.devices option.device').forEach((d) => {
                d.remove();
            });

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true })
            stream.getTracks().forEach(t => t.stop());

            const devices = await navigator.mediaDevices.enumerateDevices();
            devices.forEach(function (device) {
                if (device.kind !== "videoinput") {
                    return;
                }

                const d = document.createElement('option');
                d.value = device.deviceId;
                d.innerText = device.label == "" ? device.deviceId : device.label;
                d.dataset["deviceId"] = device.deviceId;
                d.dataset["groupId"] = device.groupId;
                d.dataset["kind"] = device.kind;
                d.dataset["label"] = device.label;
                d.classList.add('device');
                document.querySelector('.devices').appendChild(d);
            });
        };
        refreshDeviceList();
        document.querySelector(".detect").addEventListener("click", () => refreshDeviceList());

        document.querySelector(".devices").addEventListener("change", (x) => {
            currentDeviceId = document.querySelector(".devices").value;
            reStartStreamingVideo();
        });
    })();
</script>
